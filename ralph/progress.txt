---
## [2026-02-21 12:00:00] - US-001: Create salon_wallets table and enum types

### Implemented
- Created wallet_type ENUM with 'customer' and 'salon' values
- Created wallet_entry_type ENUM with all 10 entry types (customer_purse_topup, customer_purse_debit_booking, customer_purse_debit_invoice, customer_purse_reversal, salon_purse_credit_booking, salon_purse_credit_invoice, salon_purse_topup, salon_purse_withdrawal, salon_purse_reversal, salon_purse_debit_credit_purchase)
- Created salon_wallets table with id, tenant_id (unique), currency (default NGN), balance (default 0), created_at, updated_at
- Added foreign key constraint on tenant_id to tenants table with CASCADE delete
- Added index on tenant_id for faster lookups
- Created trigger to auto-update updated_at timestamp on updates

### Files Changed
- supabase/migrations/20260221120000_create_purse_enums_and_salon_wallets.sql

### Learnings
- Project uses timestamp naming convention for migrations: YYYYMMDDHHMMSS_description.sql
- No typecheck command exists in the project; only lint, test, build, dev commands
- Lint command has pre-existing eslint installation issues (eslint not found) - this is unrelated to SQL migration changes
- SQL migrations do not require TypeScript type checking
- Story acceptance criteria met: All ENUMs and tables created with proper constraints

---
## [2026-02-21 22:54:13] - US-002: Create wallet_ledger_entries table

### Implemented
- Created wallet_ledger_entries table with all required columns: id, tenant_id, wallet_type, wallet_id, entry_type, currency, amount, balance_before, balance_after, reference_type, reference_id, gateway, gateway_reference, idempotency_key, metadata (JSONB default '{}'), created_at
- Added foreign key constraint on tenant_id to tenants table with CASCADE delete
- Created unique index wallet_ledger_idempotency_idx on (tenant_id, idempotency_key) WHERE idempotency_key IS NOT NULL for idempotent transaction processing
- Created index wallet_ledger_wallet_idx on (wallet_type, wallet_id, created_at DESC) for efficient wallet-based queries

### Files Changed
- supabase/migrations/20260221120001_create_wallet_ledger_entries.sql
- ralph/prd.json (updated branchName to feat--salon-customer-purse, marked US-002 as passing)

### Learnings
- Idempotency is enforced at the database level through unique partial index on (tenant_id, idempotency_key)
- Composite index on (wallet_type, wallet_id, created_at DESC) will optimize queries for transaction history by wallet
- JSONB metadata field provides flexibility for storing transaction-specific context without schema changes
- All acceptance criteria met: table structure, foreign key, both required indexes created

---
## [2026-02-21 23:05:59] - US-003: Create salon_payout_destinations table

### Implemented
- Created payout_destination_type ENUM with 'bank' and 'mobile_money' values
- Created salon_payout_destinations table with all required columns: id, tenant_id, destination_type, country, currency, bank_code, bank_name, account_number, account_name, momo_provider, momo_number, paystack_recipient_code, is_default (default false), created_at
- Added foreign key constraint on tenant_id to tenants table with CASCADE delete
- Created index idx_salon_payout_destinations_tenant on tenant_id for faster lookups

### Files Changed
- supabase/migrations/20260221120002_create_salon_payout_destinations.sql
- ralph/prd.json (marked US-003 as passing)
- ralph/progress.txt (this file)

### Learnings
- Table supports both bank accounts (for Nigeria NUBAN and Ghana GHIPSS) and mobile money providers (MTN, Vodafone, AirtelTigo)
- paystack_recipient_code column stores Paystack's recipient code for transfer API calls
- is_default flag allows tenants to mark a preferred payout destination
- Multiple destination types (bank vs mobile_money) can be stored per tenant for flexibility

---
## [2026-02-21 23:18:00] - US-004: Create salon_withdrawals table

### Implemented
- Created withdrawal_status ENUM with 'pending', 'processing', 'completed', 'failed' values
- Created salon_withdrawals table with all required columns: id, tenant_id, salon_wallet_id, payout_destination_id, currency, amount, status (default 'pending'), paystack_transfer_code, paystack_reference, failure_reason, requested_at (default NOW())
- Added foreign key constraint on tenant_id to tenants table with CASCADE delete
- Added foreign key constraint on salon_wallet_id to salon_wallets table with CASCADE delete
- Added foreign key constraint on payout_destination_id to salon_payout_destinations table with CASCADE delete
- Created indexes for tenant_id, salon_wallet_id, and status for faster lookups

### Files Changed
- supabase/migrations/20260221120003_create_salon_withdrawals.sql
- ralph/prd.json (marked US-004 as passing)
- ralph/progress.txt (this file)

### Learnings
- Table tracks the full lifecycle of a withdrawal request from pending → processing → completed/failed
- paystack_transfer_code and paystack_reference store Paystack's transfer identifiers
- failure_reason captures error messages when withdrawals fail
- Amount is stored with NUMERIC(12, 2) precision to handle currencies accurately
- All foreign keys cascade on delete to maintain referential integrity

---
## [2026-02-21 23:45:00] - US-005: Create messaging_credit_purchases table

### Implemented
- Created messaging_credit_purchases table with all required columns: id, tenant_id, credits (INTEGER), currency, amount, paid_via (TEXT), payment_intent_id (UUID), gateway_reference, created_at
- Added CHECK constraint on paid_via to only accept 'salon_purse' or 'paystack' values
- Added foreign key constraint on tenant_id to tenants table with CASCADE delete
- Created indexes for tenant_id, paid_via, and created_at for query performance

### Files Changed
- supabase/migrations/20260221120004_create_messaging_credit_purchases.sql
- ralph/prd.json (marked US-005 as passing)
- ralph/progress.txt (this file)

### Learnings
- Used CHECK constraint instead of ENUM for paid_via since only 2 fixed values are needed
- payment_intent_id is nullable since it's only populated for Paystack payments (not purse payments)
- Amount uses NUMERIC(12, 2) for consistent currency precision
- All acceptance criteria met: table structure, foreign key, and paid_via constraint

